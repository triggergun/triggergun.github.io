# spring框架是怎么定义事务？

在5.2的spring框架的`spring-tx`模块的

```java
package org.springframework.transaction;
```

包中定义了一个TransactionDefinition接口。

## 接口信息

- **接口名**：`TransactionDefinition`
- **作用**：定义符合Spring规范的事务属性，基于类似于EJB CMT属性的传播行为定义

------

## 事务传播行为常量（7个）

| 常量名                      | 值   | 方法                                    | 作用描述                                               |
| :-------------------------- | :--- | :-------------------------------------- | :----------------------------------------------------- |
| `PROPAGATION_REQUIRED`      | 0    | `getPropagationBehavior()` 默认返回此值 | **支持当前事务，如果不存在则创建新事务**（默认设置）   |
| `PROPAGATION_SUPPORTS`      | 1    | -                                       | **支持当前事务，如果不存在则以非事务方式执行**         |
| `PROPAGATION_MANDATORY`     | 2    | -                                       | **必须在事务中运行，否则抛出异常**                     |
| `PROPAGATION_REQUIRES_NEW`  | 3    | -                                       | **总是创建新事务，如果存在当前事务则挂起**             |
| `PROPAGATION_NOT_SUPPORTED` | 4    | -                                       | **以非事务方式执行，如果存在当前事务则挂起**           |
| `PROPAGATION_NEVER`         | 5    | -                                       | **不能在事务中运行，否则抛出异常**                     |
| `PROPAGATION_NESTED`        | 6    | -                                       | **如果存在当前事务则在嵌套事务中执行，否则同REQUIRED** |

------

## 事务隔离级别常量（5个）

| 常量名                       | 值   | 方法                               | 作用描述                                   |
| :--------------------------- | :--- | :--------------------------------- | :----------------------------------------- |
| `ISOLATION_DEFAULT`          | -1   | `getIsolationLevel()` 默认返回此值 | **使用底层数据存储的默认隔离级别**         |
| `ISOLATION_READ_UNCOMMITTED` | 1    | -                                  | **读未提交**（允许脏读、不可重复读、幻读） |
| `ISOLATION_READ_COMMITTED`   | 2    | -                                  | **读已提交**（防止脏读）                   |
| `ISOLATION_REPEATABLE_READ`  | 4    | -                                  | **可重复读**（防止脏读、不可重复读）       |
| `ISOLATION_SERIALIZABLE`     | 8    | -                                  | **串行化**（防止所有并发问题）             |

------

## 超时时间常量（1个）

| 常量名            | 值   | 方法                        | 作用描述                                   |
| :---------------- | :--- | :-------------------------- | :----------------------------------------- |
| `TIMEOUT_DEFAULT` | -1   | `getTimeout()` 默认返回此值 | **使用底层事务系统默认超时，或不支持超时** |

------

## 接口方法（6个）

### 1. 传播行为相关

| 方法签名                       | 默认实现                        | 返回值         | 说明             |
| :----------------------------- | :------------------------------ | :------------- | :--------------- |
| `int getPropagationBehavior()` | 返回 `PROPAGATION_REQUIRED` (0) | 传播行为常量值 | 获取事务传播行为 |

### 2. 隔离级别相关

| 方法签名                  | 默认实现                      | 返回值         | 说明             |
| :------------------------ | :---------------------------- | :------------- | :--------------- |
| `int getIsolationLevel()` | 返回 `ISOLATION_DEFAULT` (-1) | 隔离级别常量值 | 获取事务隔离级别 |

### 3. 超时时间相关

| 方法签名           | 默认实现                    | 返回值 | 说明             |
| :----------------- | :-------------------------- | :----- | :--------------- |
| `int getTimeout()` | 返回 `TIMEOUT_DEFAULT` (-1) | 秒数   | 获取事务超时时间 |

### 4. 只读标志相关

| 方法签名               | 默认实现     | 返回值  | 说明           |
| :--------------------- | :----------- | :------ | :------------- |
| `boolean isReadOnly()` | 返回 `false` | boolean | 事务是否为只读 |

### 5. 事务名称相关

| 方法签名           | 默认实现    | 返回值 | 说明                     |
| :----------------- | :---------- | :----- | :----------------------- |
| `String getName()` | 返回 `null` | 字符串 | 获取事务名称（用于监控） |

### 6. 静态构建方法

| 方法签名                                      | 返回值                  | 说明                               |
| :-------------------------------------------- | :---------------------- | :--------------------------------- |
| `static TransactionDefinition withDefaults()` | `TransactionDefinition` | 返回具有默认值的不可修改的事务定义 |

## 关键行为规则总结

### 常量与方法的对应关系

```java
// 常量定义（用于配置）
PROPAGATION_REQUIRED = 0

// 方法获取（运行时使用）
getPropagationBehavior() -> 默认返回0
```



### 重要约束条件

1. **隔离级别和超时只在真正启动新事务时生效**

   - 仅适用于：`PROPAGATION_REQUIRED`、`PROPAGATION_REQUIRES_NEW`、`PROPAGATION_NESTED`
   - 在其他传播行为中设置这些属性通常无意义

2. **只读标志适用范围更广**

   ```java
   // 适用于：
   // 1. 实际资源事务（PROPAGATION_REQUIRED/REQUIRES_NEW）
   // 2. 资源级别非事务运行（PROPAGATION_SUPPORTS）
   ```

   

3. **特殊传播行为的注意事项**

   - `PROPAGATION_NESTED`：需要特定事务管理器支持
   - 事务挂起：不是所有事务管理器都支持

### 设计模式体现

这是一个典型的**接口定义模式**：

- **常量定义**：提供标准化的配置选项
- **getter方法**：提供运行时访问接口
- **默认实现**：提供合理的默认行为
- **静态工厂方法**：`withDefaults()` 提供便捷的创建方式

这个接口的设计很好地体现了**约定优于配置**的原则，为Spring事务管理提供了灵活而统一的基础。