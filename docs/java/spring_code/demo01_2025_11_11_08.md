# Spring事务处理的核心流程

Spring事务处理的核心流程涉及以下几个关键组件：

## 1. 主要关注的核心类
`Transactional` - @Transactional注解定义类 `TransactionAspectSupport` - 事务切面支持基类 `TransactionInterceptor` - 事务拦截器 `AnnotationTransactionAttributeSource` - 注解事务属性源 `SpringTransactionAnnotationParser` - Spring事务注解解析器

## 2. 关键断点设置位置 注解解析阶段断点：
- `SpringTransactionAnnotationParser.java` - parseTransactionAnnotation 方法
- `AnnotationTransactionAttributeSource.java` - determineTransactionAttribute 方法 事务拦截阶段断点：
- `TransactionInterceptor.java` - invoke 方法
- `TransactionAspectSupport.java` - invokeWithinTransaction 方法（核心方法） 事务管理阶段断点：
- `PlatformTransactionManager.java` - getTransaction 、 commit 、 rollback 方法
- `AbstractPlatformTransactionManager.java` - 具体的事务管理实现

## 3. 调试步骤和策略

第1步：设置关键断点
在IDE中设置以下关键断点：

1. TransactionAspectSupport.invokeWithinTransaction - 事务方法调用的入口
2. TransactionInterceptor.invoke - AOP拦截器入口
3. AbstractPlatformTransactionManager.getTransaction - 事务获取逻辑
4. AbstractPlatformTransactionManager.processCommit - 事务提交逻辑
5. AbstractPlatformTransactionManager.processRollback - 事务回滚逻辑

第四步：调试流程
1. 启动调试 ：以调试模式启动应用
2. 触发事务 ：调用testTransactionalMethod方法
3. 跟踪调用栈 ：
   - TransactionInterceptor.invoke (AOP拦截)
   - TransactionAspectSupport.invokeWithinTransaction (事务切面处理)
   - 创建TransactionInfo对象
   - 调用PlatformTransactionManager.getTransaction获取事务
   - 执行业务方法
   - 根据执行结果提交或回滚事务
## 4. 重点关注的事务处理阶段4阶段

阶段1：注解解析

- 断点位置 ：SpringTransactionAnnotationParser.parseTransactionAnnotation

- 关注内容 ：如何将@Transactional注解属性转换为TransactionAttribute 

阶段2：事务创建

- 断点位置 ：AbstractPlatformTransactionManager.getTransaction

- 关注内容 ：事务传播行为的处理、事务同步器的注册 

阶段3：方法执行

- 断点位置 ：TransactionAspectSupport.invokeWithinTransaction中的方法调用部分

- 关注内容 ：业务方法在事务上下文中的执行 

阶段4：事务完成

- 断点位置 ：AbstractPlatformTransactionManager.processCommit/processRollback

- 关注内容 ：事务提交/回滚的具体逻辑

## 5. 调试技巧和注意事项
1. 使用条件断点 ：在TransactionAspectSupport.invokeWithinTransaction方法中设置条件断点，只针对特定方法名进行调试
2. 观察TransactionInfo对象 ：关注transactionInfoHolder中的TransactionInfo状态变化
3. 跟踪事务状态 ：使用TransactionSynchronizationManager观察当前线程的事务状态
4. 注意事务传播行为 ：调试时特别注意不同传播行为（REQUIRED、REQUIRES_NEW等）的处理差异
通过以上调试策略，你可以深入理解Spring事务处理的完整流程，包括注解解析、AOP拦截、事务管理、资源同步等关键环节